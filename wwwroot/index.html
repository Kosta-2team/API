<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignalR Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #log {
            max-width: 600px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>MongoDB Change Stream Listener</h1>
    <div id="log">
        <strong>Change Logs:</strong>
        <ul id="log-list"></ul>
    </div>
    <div id="all-results">
        <strong>All Results:</strong>
        <ul id="results-list"></ul>
    </div>
    <div id="recent-results">
        <strong>Recent Results:</strong>
        <ul id="recent-list"></ul>
    </div>

    <script>
        const receivedIds = new Map(); // ID와 데이터 상태 저장

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/hubs/notification")
            .build();

        // 중복된 이벤트 리스너가 등록되지 않도록 제거
        connection.on("ReceiveChange", async (data) => {
            const id = data.id;

            if (!id) {
                console.warn("ID가 없는 데이터:", data);
                return;
            }

            const currentData = receivedIds.get(id);

            // 이전 데이터와 동일하면 무시
            if (currentData && JSON.stringify(currentData) === JSON.stringify(data)) {
                return; // 중복 데이터는 로그 출력 없이 무시
            }

            // 데이터 변경 로그
            console.log("데이터 변경 감지:", data);

            // 최신 데이터 저장
            receivedIds.set(id, data);

            // UI 변경 로그 업데이트
            const logList = document.getElementById("log-list");
            let listItem = document.querySelector(`li[data-id="${id}"]`);

            if (listItem) {
                listItem.textContent = JSON.stringify(data); // 기존 데이터 업데이트
            } else {
                listItem = document.createElement("li");
                listItem.setAttribute("data-id", id);
                listItem.textContent = JSON.stringify(data);
                logList.appendChild(listItem); // 새로운 데이터 추가
            }

            // 모든 데이터 요청 및 갱신
            await updateAllResults();
        });

        // 모든 데이터 갱신
        async function updateAllResults() {
            try {
                const response = await fetch('https://localhost:7002/api/Data/database1'); // 데이터 요청
                const allData = await response.json();

                const resultsList = document.getElementById("results-list");
                resultsList.innerHTML = ""; // 기존 데이터를 지우고

                // 데이터 가공 후 렌더링
                allData.forEach(item => {
                    const listItem = document.createElement("li");

                    // 원하는 형식으로 데이터 구성
                    const formattedData = `입차 시간: ${item.inTime} 출차 시간: ${item.outTime} 주차 시간: ${item.hoursParked} 시간 당 가격: ${item.ratePerHour} 결제 금액: ${item.totalCost}`;
                    // const formattedData = `${item.id}`;
                    listItem.textContent = formattedData.trim(); // 줄바꿈 제거
                    resultsList.appendChild(listItem);
                });

                // 최근 5개 데이터를 갱신
                updateRecentResults(allData);
            } catch (error) {
                console.error("모든 데이터를 가져오는 데 실패:", error);
            }
        }

        // 최근 5개 데이터 갱신
        function getTimestampFromObjectId(id) {
            // MongoDB ObjectId에서 타임스탬프 추출
            return new Date(parseInt(id.substring(0, 8), 16) * 1000);
        }

        function updateRecentResults(allData) {
            // 데이터를 ObjectId 기준으로 내림차순 정렬
            const sortedData = allData.sort((a, b) => getTimestampFromObjectId(b.id) - getTimestampFromObjectId(a.id));

            // 최근 5개 데이터 추출
            const recent = sortedData.slice(0, 5);

            // UI 갱신
            const recentList = document.getElementById("recent-list");
            recentList.innerHTML = ""; // 기존 데이터를 지우고

            // 데이터 렌더링
            recent.forEach(item => {
                const listItem = document.createElement("li");

                // 원하는 형식으로 데이터 구성
                const formattedData = `입차 시간: ${item.inTime} 출차 시간: ${item.outTime} 주차 시간: ${item.hoursParked} 시간 당 가격: ${item.ratePerHour} 결제 금액: ${item.totalCost}`;
                listItem.textContent = formattedData.trim();
                recentList.appendChild(listItem);
            });
        }

        // SignalR 연결 시작
        connection.start()
            .then(() => console.log("SignalR 연결 성공"))
            .catch(err => console.error("SignalR 연결 실패:", err));
    </script>
</body>
</html>
